Lists=new Meteor.Collection("lists");Todos=new Meteor.Collection("todos");Session.setDefault("list_id",null);Session.setDefault("tag_filter",null);Session.setDefault("editing_addtag",null);Session.setDefault("editing_listname",null);Session.setDefault("editing_itemname",null);var listsHandle=Meteor.subscribe("lists",function(){if(!Session.get("list_id")){var a=Lists.findOne({},{sort:{name:1}});if(a){Router.setList(a._id)}}});var todosHandle=null;Deps.autorun(function(){var a=Session.get("list_id");if(a){todosHandle=Meteor.subscribe("todos",a)}else{todosHandle=null}});var okCancelEvents=function(a,e){var c=e.ok||function(){};var d=e.cancel||function(){};var b={};b["keyup "+a+", keydown "+a+", focusout "+a]=function(f){if(f.type==="keydown"&&f.which===27){d.call(this,f)}else{if(f.type==="keyup"&&f.which===13||f.type==="focusout"){var g=String(f.target.value||"");if(g){c.call(this,g,f)}else{d.call(this,f)}}}};return b};var activateInput=function(a){a.focus();a.select()};Template.lists.loading=function(){return !listsHandle.ready()};Template.lists.lists=function(){return Lists.find({},{sort:{name:1}})};Template.lists.events({"mousedown .list":function(a){Router.setList(this._id)},"click .list":function(a){a.preventDefault()},"dblclick .list":function(a,b){Session.set("editing_listname",this._id);Deps.flush();activateInput(b.find("#list-name-input"))}});Template.lists.events(okCancelEvents("#new-list",{ok:function(b,a){var c=Lists.insert({name:b});Router.setList(c);a.target.value=""}}));Template.lists.events(okCancelEvents("#list-name-input",{ok:function(a){Lists.update(this._id,{$set:{name:a}});Session.set("editing_listname",null)},cancel:function(){Session.set("editing_listname",null)}}));Template.lists.selected=function(){return Session.equals("list_id",this._id)?"selected":""};Template.lists.name_class=function(){return this.name?"":"empty"};Template.lists.editing=function(){return Session.equals("editing_listname",this._id)};Template.todos.loading=function(){return todosHandle&&!todosHandle.ready()};Template.todos.any_list_selected=function(){return !Session.equals("list_id",null)};Template.todos.events(okCancelEvents("#new-todo",{ok:function(c,b){var a=Session.get("tag_filter");Todos.insert({text:c,list_id:Session.get("list_id"),done:false,timestamp:(new Date()).getTime(),tags:a?[a]:[]});b.target.value=""}}));Template.todos.todos=function(){var c=Session.get("list_id");if(!c){return{}}var b={list_id:c};var a=Session.get("tag_filter");if(a){b.tags=a}return Todos.find(b,{sort:{timestamp:1}})};Template.todo_item.tag_objs=function(){var a=this._id;return _.map(this.tags||[],function(b){return{todo_id:a,tag:b}})};Template.todo_item.done_class=function(){return this.done?"done":""};Template.todo_item.done_checkbox=function(){return this.done?'checked="checked"':""};Template.todo_item.editing=function(){return Session.equals("editing_itemname",this._id)};Template.todo_item.adding_tag=function(){return Session.equals("editing_addtag",this._id)};Template.todo_item.events({"click .check":function(){Todos.update(this._id,{$set:{done:!this.done}})},"click .destroy":function(){Todos.remove(this._id)},"click .addtag":function(a,b){Session.set("editing_addtag",this._id);Deps.flush();activateInput(b.find("#edittag-input"))},"dblclick .display .todo-text":function(a,b){Session.set("editing_itemname",this._id);Deps.flush();activateInput(b.find("#todo-input"))},"click .remove":function(b){var a=this.tag;var c=this.todo_id;b.target.parentNode.style.opacity=0;Meteor.setTimeout(function(){Todos.update({_id:c},{$pull:{tags:a}})},300)}});Template.todo_item.events(okCancelEvents("#todo-input",{ok:function(a){Todos.update(this._id,{$set:{text:a}});Session.set("editing_itemname",null)},cancel:function(){Session.set("editing_itemname",null)}}));Template.todo_item.events(okCancelEvents("#edittag-input",{ok:function(a){Todos.update(this._id,{$addToSet:{tags:a}});Session.set("editing_addtag",null)},cancel:function(){Session.set("editing_addtag",null)}}));Template.tag_filter.tags=function(){var a=[];var b=0;Todos.find({list_id:Session.get("list_id")}).forEach(function(c){_.each(c.tags,function(d){var e=_.find(a,function(f){return f.tag===d});if(!e){a.push({tag:d,count:1})}else{e.count++}});b++});a=_.sortBy(a,function(c){return c.tag});a.unshift({tag:null,count:b});return a};Template.tag_filter.tag_text=function(){return this.tag||"All items"};Template.tag_filter.selected=function(){return Session.equals("tag_filter",this.tag)?"selected":""};Template.tag_filter.events({"mousedown .tag":function(){if(Session.equals("tag_filter",this.tag)){Session.set("tag_filter",null)}else{Session.set("tag_filter",this.tag)}}});var TodosRouter=Backbone.Router.extend({routes:{":list_id":"main"},main:function(b){var a=Session.get("list_id");if(a!==b){Session.set("list_id",b);Session.set("tag_filter",null)}},setList:function(a){this.navigate(a,true)}});Router=new TodosRouter;Meteor.startup(function(){Backbone.history.start({pushState:true})});